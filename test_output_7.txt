
> task-manager-backend@1.0.0 test
> jest tests/unit/admin.service.test.js

  console.log
    [dotenv@17.2.3] injecting env (22) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

      at _log (node_modules/dotenv/lib/main.js:142:11)

node.exe : FAIL 
tests/unit/admin.service.test.js (8.544 s)
At C:\Program Files\nodejs\npm.ps1:29 char:3
+   & $NODE_EXE $NPM_CLI_JS $args
+   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified:  
   (FAIL tests/unit...st.js (8.544 s):Strin  
  g) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandE 
   rror
 
  AdminService
    login
      ├ù should successfully login with 
valid credentials (12 ms)
      ├ù should throw error for invalid 
credentials (2 ms)
      ├ù should throw error for non-existent 
admin (2 ms)
      ├ù should lock account after 5 failed 
attempts (1 ms)
      ├ù should handle remember me option 
correctly (1 ms)
    refreshToken
      ├ù should refresh tokens with valid 
refresh token (19 ms)
      ├ù should throw error for invalid 
refresh token (3 ms)
      ├ù should throw error for expired 
refresh token (3 ms)
      ├ù should throw error for token 
version mismatch (3 ms)
      ├ù should throw error for locked 
account (3 ms)
      ├ù should increment token version on 
refresh (2 ms)
    updateProfile
      ├ù should update admin profile 
successfully (1 ms)
      ├ù should throw error for duplicate 
email (1 ms)
      ├ù should allow same email for same 
admin (1 ms)
    forgotPassword
      ├ù should generate and send OTP for 
valid admin (1 ms)
      ├ù should throw error for non-existent 
admin (1 ms)
      ├ù should handle locked account (1 ms)

  ΓùÅ AdminService ΓÇ║ login ΓÇ║ should 
successfully login with valid credentials

    TypeError: AdminRepository.findByEmail.mo
ckResolvedValue is not a function

    [0m [90m 59 |[39m       
mockAdmin[33m.[39mmatchPassword 
[33m=[39m jest[33m.[39mfn()[33m.[39mmoc
kResolvedValue([36mtrue[39m)[33m;[39m
     [90m 60 |[39m
    [31m[1m>[22m[39m[90m 61 |[39m      
 [33mAdminRepository[39m[33m.[39mfindByEm
ail[33m.[39mmockResolvedValue(mockAdmin)[3
3m;[39m
     [90m    |[39m                         
          [31m[1m^[22m[39m
     [90m 62 |[39m       [33mAdminReposito
ry[39m[33m.[39mupdateById[33m.[39mmockRe
solvedValue(mockAdmin)[33m;[39m
     [90m 63 |[39m
     [90m 64 |[39m       [90m// 
Act[39m[0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:61:35)

  ΓùÅ AdminService ΓÇ║ login ΓÇ║ should 
throw error for invalid credentials

    TypeError: AdminRepository.findByEmail.mo
ckResolvedValue is not a function

    [0m [90m 76 |[39m       [90m// 
Arrange[39m
     [90m 77 |[39m       [36mconst[39m 
mockAdmin [33m=[39m { 
[33m...[39madminData[33m,[39m 
matchPassword[33m:[39m jest[33m.[39mfn()
[33m.[39mmockResolvedValue([36mfalse[39m) 
}[33m;[39m
    [31m[1m>[22m[39m[90m 78 |[39m      
 [33mAdminRepository[39m[33m.[39mfindByEm
ail[33m.[39mmockResolvedValue(mockAdmin)[3
3m;[39m
     [90m    |[39m                         
          [31m[1m^[22m[39m
     [90m 79 |[39m
     [90m 80 |[39m       [90m// Act & 
Assert[39m
     [90m 81 |[39m       [36mawait[39m [
33mTestUtils[39m[33m.[39mexpectAsyncError(
[0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:78:35)

  ΓùÅ AdminService ΓÇ║ login ΓÇ║ should 
throw error for non-existent admin

    TypeError: AdminRepository.findByEmail.mo
ckResolvedValue is not a function

    [0m [90m 88 |[39m     it([32m'should 
throw error for non-existent 
admin'[39m[33m,[39m [36masync[39m () 
[33m=>[39m {
     [90m 89 |[39m       [90m// 
Arrange[39m
    [31m[1m>[22m[39m[90m 90 |[39m      
 [33mAdminRepository[39m[33m.[39mfindByEm
ail[33m.[39mmockResolvedValue([36mnull[39
m)[33m;[39m
     [90m    |[39m                         
          [31m[1m^[22m[39m
     [90m 91 |[39m
     [90m 92 |[39m       [90m// Act & 
Assert[39m
     [90m 93 |[39m       [36mawait[39m [
33mTestUtils[39m[33m.[39mexpectAsyncError(
[0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:90:35)

  ΓùÅ AdminService ΓÇ║ login ΓÇ║ should lock 
account after 5 failed attempts

    TypeError: AdminRepository.findByEmail.mo
ckResolvedValue is not a function

    [0m [90m 107 |[39m       }[33m;[39m
     [90m 108 |[39m
    [31m[1m>[22m[39m[90m 109 |[39m     
  [33mAdminRepository[39m[33m.[39mfindByE
mail[33m.[39mmockResolvedValue(mockAdmin)[
33m;[39m
     [90m     |[39m                        
           [31m[1m^[22m[39m
     [90m 110 |[39m
     [90m 111 |[39m       [90m// Act & 
Assert[39m
     [90m 112 |[39m       [36mawait[39m 
[33mTestUtils[39m[33m.[39mexpectAsyncError
([0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:109:35)

  ΓùÅ AdminService ΓÇ║ login ΓÇ║ should 
handle remember me option correctly

    TypeError: AdminRepository.findByEmail.mo
ckResolvedValue is not a function

    [0m [90m 130 |[39m       
mockAdmin[33m.[39mmatchPassword 
[33m=[39m jest[33m.[39mfn()[33m.[39mmoc
kResolvedValue([36mtrue[39m)[33m;[39m
     [90m 131 |[39m
    [31m[1m>[22m[39m[90m 132 |[39m     
  [33mAdminRepository[39m[33m.[39mfindByE
mail[33m.[39mmockResolvedValue(mockAdmin)[
33m;[39m
     [90m     |[39m                        
           [31m[1m^[22m[39m
     [90m 133 |[39m       [33mAdminReposit
ory[39m[33m.[39mupdateById[33m.[39mmockR
esolvedValue(mockAdmin)[33m;[39m
     [90m 134 |[39m
     [90m 135 |[39m       [90m// 
Act[39m[0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:132:35)

  ΓùÅ AdminService ΓÇ║ refreshToken ΓÇ║ 
should refresh tokens with valid refresh 
token

    TypeError: 
AdminRepository.findById.mockResolvedValue 
is not a function

    [0m [90m 155 |[39m       
validRefreshToken [33m=[39m [33mTestUtils
[39m[33m.[39mgenerateJWT(mockAdmin[33m.[3
9m_id[33m,[39m 
[32m'test-refresh-secret'[39m[33m,[39m 
[32m'30d'[39m)[33m;[39m
     [90m 156 |[39m
    [31m[1m>[22m[39m[90m 157 |[39m     
  [33mAdminRepository[39m[33m.[39mfindByI
d[33m.[39mmockResolvedValue(mockAdmin)[33m
;[39m
     [90m     |[39m                        
        [31m[1m^[22m[39m
     [90m 158 |[39m       [33mAdminReposit
ory[39m[33m.[39mupdateById[33m.[39mmockR
esolvedValue(mockAdmin)[33m;[39m
     [90m 159 |[39m     })[33m;[39m
     [90m 160 |[39m[0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:157:32)

  ΓùÅ AdminService ΓÇ║ refreshToken ΓÇ║ 
should throw error for invalid refresh token

    TypeError: 
AdminRepository.findById.mockResolvedValue 
is not a function

    [0m [90m 155 |[39m       
validRefreshToken [33m=[39m [33mTestUtils
[39m[33m.[39mgenerateJWT(mockAdmin[33m.[3
9m_id[33m,[39m 
[32m'test-refresh-secret'[39m[33m,[39m 
[32m'30d'[39m)[33m;[39m
     [90m 156 |[39m
    [31m[1m>[22m[39m[90m 157 |[39m     
  [33mAdminRepository[39m[33m.[39mfindByI
d[33m.[39mmockResolvedValue(mockAdmin)[33m
;[39m
     [90m     |[39m                        
        [31m[1m^[22m[39m
     [90m 158 |[39m       [33mAdminReposit
ory[39m[33m.[39mupdateById[33m.[39mmockR
esolvedValue(mockAdmin)[33m;[39m
     [90m 159 |[39m     })[33m;[39m
     [90m 160 |[39m[0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:157:32)

  ΓùÅ AdminService ΓÇ║ refreshToken ΓÇ║ 
should throw error for expired refresh token

    TypeError: 
AdminRepository.findById.mockResolvedValue 
is not a function

    [0m [90m 155 |[39m       
validRefreshToken [33m=[39m [33mTestUtils
[39m[33m.[39mgenerateJWT(mockAdmin[33m.[3
9m_id[33m,[39m 
[32m'test-refresh-secret'[39m[33m,[39m 
[32m'30d'[39m)[33m;[39m
     [90m 156 |[39m
    [31m[1m>[22m[39m[90m 157 |[39m     
  [33mAdminRepository[39m[33m.[39mfindByI
d[33m.[39mmockResolvedValue(mockAdmin)[33m
;[39m
     [90m     |[39m                        
        [31m[1m^[22m[39m
     [90m 158 |[39m       [33mAdminReposit
ory[39m[33m.[39mupdateById[33m.[39mmockR
esolvedValue(mockAdmin)[33m;[39m
     [90m 159 |[39m     })[33m;[39m
     [90m 160 |[39m[0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:157:32)

  ΓùÅ AdminService ΓÇ║ refreshToken ΓÇ║ 
should throw error for token version mismatch

    TypeError: 
AdminRepository.findById.mockResolvedValue 
is not a function

    [0m [90m 155 |[39m       
validRefreshToken [33m=[39m [33mTestUtils
[39m[33m.[39mgenerateJWT(mockAdmin[33m.[3
9m_id[33m,[39m 
[32m'test-refresh-secret'[39m[33m,[39m 
[32m'30d'[39m)[33m;[39m
     [90m 156 |[39m
    [31m[1m>[22m[39m[90m 157 |[39m     
  [33mAdminRepository[39m[33m.[39mfindByI
d[33m.[39mmockResolvedValue(mockAdmin)[33m
;[39m
     [90m     |[39m                        
        [31m[1m^[22m[39m
     [90m 158 |[39m       [33mAdminReposit
ory[39m[33m.[39mupdateById[33m.[39mmockR
esolvedValue(mockAdmin)[33m;[39m
     [90m 159 |[39m     })[33m;[39m
     [90m 160 |[39m[0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:157:32)

  ΓùÅ AdminService ΓÇ║ refreshToken ΓÇ║ 
should throw error for locked account

    TypeError: 
AdminRepository.findById.mockResolvedValue 
is not a function

    [0m [90m 155 |[39m       
validRefreshToken [33m=[39m [33mTestUtils
[39m[33m.[39mgenerateJWT(mockAdmin[33m.[3
9m_id[33m,[39m 
[32m'test-refresh-secret'[39m[33m,[39m 
[32m'30d'[39m)[33m;[39m
     [90m 156 |[39m
    [31m[1m>[22m[39m[90m 157 |[39m     
  [33mAdminRepository[39m[33m.[39mfindByI
d[33m.[39mmockResolvedValue(mockAdmin)[33m
;[39m
     [90m     |[39m                        
        [31m[1m^[22m[39m
     [90m 158 |[39m       [33mAdminReposit
ory[39m[33m.[39mupdateById[33m.[39mmockR
esolvedValue(mockAdmin)[33m;[39m
     [90m 159 |[39m     })[33m;[39m
     [90m 160 |[39m[0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:157:32)

  ΓùÅ AdminService ΓÇ║ refreshToken ΓÇ║ 
should increment token version on refresh

    TypeError: 
AdminRepository.findById.mockResolvedValue 
is not a function

    [0m [90m 155 |[39m       
validRefreshToken [33m=[39m [33mTestUtils
[39m[33m.[39mgenerateJWT(mockAdmin[33m.[3
9m_id[33m,[39m 
[32m'test-refresh-secret'[39m[33m,[39m 
[32m'30d'[39m)[33m;[39m
     [90m 156 |[39m
    [31m[1m>[22m[39m[90m 157 |[39m     
  [33mAdminRepository[39m[33m.[39mfindByI
d[33m.[39mmockResolvedValue(mockAdmin)[33m
;[39m
     [90m     |[39m                        
        [31m[1m^[22m[39m
     [90m 158 |[39m       [33mAdminReposit
ory[39m[33m.[39mupdateById[33m.[39mmockR
esolvedValue(mockAdmin)[33m;[39m
     [90m 159 |[39m     })[33m;[39m
     [90m 160 |[39m[0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:157:32)

  ΓùÅ AdminService ΓÇ║ updateProfile ΓÇ║ 
should update admin profile successfully

    TypeError: AdminRepository.findByEmail.mo
ckResolvedValue is not a function

    [0m [90m 271 |[39m       
[36mconst[39m updateData [33m=[39m { 
name[33m:[39m [32m'Updated Name'[39m 
}[33m;[39m
     [90m 272 |[39m
    [31m[1m>[22m[39m[90m 273 |[39m     
  [33mAdminRepository[39m[33m.[39mfindByE
mail[33m.[39mmockResolvedValue([36mnull[3
9m)[33m;[39m [90m// No duplicate[39m
     [90m     |[39m                        
           [31m[1m^[22m[39m
     [90m 274 |[39m       [33mAdminReposit
ory[39m[33m.[39mupdateById[33m.[39mmockR
esolvedValue({ 
[33m...[39mmockAdmin[33m,[39m 
[33m...[39mupdateData })[33m;[39m
     [90m 275 |[39m
     [90m 276 |[39m       [90m// 
Act[39m[0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:273:35)

  ΓùÅ AdminService ΓÇ║ updateProfile ΓÇ║ 
should throw error for duplicate email

    TypeError: AdminRepository.findByEmail.mo
ckResolvedValue is not a function

    [0m [90m 288 |[39m       
[36mconst[39m updateData [33m=[39m { 
email[33m:[39m 
[32m'existing@test.com'[39m }[33m;[39m
     [90m 289 |[39m
    [31m[1m>[22m[39m[90m 290 |[39m     
  [33mAdminRepository[39m[33m.[39mfindByE
mail[33m.[39mmockResolvedValue(existingAdmi
n)[33m;[39m
     [90m     |[39m                        
           [31m[1m^[22m[39m
     [90m 291 |[39m
     [90m 292 |[39m       [90m// Act & 
Assert[39m
     [90m 293 |[39m       [36mawait[39m 
[33mTestUtils[39m[33m.[39mexpectAsyncError
([0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:290:35)

  ΓùÅ AdminService ΓÇ║ updateProfile ΓÇ║ 
should allow same email for same admin

    TypeError: AdminRepository.findByEmail.mo
ckResolvedValue is not a function

    [0m [90m 303 |[39m       
[36mconst[39m updateData [33m=[39m { 
email[33m:[39m mockAdmin[33m.[39memail 
}[33m;[39m
     [90m 304 |[39m
    [31m[1m>[22m[39m[90m 305 |[39m     
  [33mAdminRepository[39m[33m.[39mfindByE
mail[33m.[39mmockResolvedValue(mockAdmin)[
33m;[39m [90m// Same admin[39m
     [90m     |[39m                        
           [31m[1m^[22m[39m
     [90m 306 |[39m       [33mAdminReposit
ory[39m[33m.[39mupdateById[33m.[39mmockR
esolvedValue(mockAdmin)[33m;[39m
     [90m 307 |[39m
     [90m 308 |[39m       [90m// Act ΓÇö 
pass adminId as string so the service 
comparison works[39m[0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:305:35)

  ΓùÅ AdminService ΓÇ║ forgotPassword ΓÇ║ 
should generate and send OTP for valid admin

    TypeError: AdminRepository.findByEmail.mo
ckResolvedValue is not a function

    [0m [90m 318 |[39m       [90m// 
Arrange[39m
     [90m 319 |[39m       [36mconst[39m 
mockAdmin [33m=[39m { 
[33m...[39madminData[33m,[39m 
_id[33m:[39m [36mnew[39m mongoose[33m.[
39m[33mTypes[39m[33m.[39m[33mObjectId[3
9m() }[33m;[39m
    [31m[1m>[22m[39m[90m 320 |[39m     
  [33mAdminRepository[39m[33m.[39mfindByE
mail[33m.[39mmockResolvedValue(mockAdmin)[
33m;[39m
     [90m     |[39m                        
           [31m[1m^[22m[39m
     [90m 321 |[39m       [33mAdminReposit
ory[39m[33m.[39mupdateById[33m.[39mmockR
esolvedValue(mockAdmin)[33m;[39m
     [90m 322 |[39m
     [90m 323 |[39m       [90m// 
Act[39m[0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:320:35)

  ΓùÅ AdminService ΓÇ║ forgotPassword ΓÇ║ 
should throw error for non-existent admin

    TypeError: AdminRepository.findByEmail.mo
ckResolvedValue is not a function

    [0m [90m 337 |[39m     
it([32m'should throw error for non-existent 
admin'[39m[33m,[39m [36masync[39m () 
[33m=>[39m {
     [90m 338 |[39m       [90m// 
Arrange[39m
    [31m[1m>[22m[39m[90m 339 |[39m     
  [33mAdminRepository[39m[33m.[39mfindByE
mail[33m.[39mmockResolvedValue([36mnull[3
9m)[33m;[39m
     [90m     |[39m                        
           [31m[1m^[22m[39m
     [90m 340 |[39m
     [90m 341 |[39m       [90m// Act & 
Assert[39m
     [90m 342 |[39m       [36mawait[39m 
[33mTestUtils[39m[33m.[39mexpectAsyncError
([0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:339:35)

  ΓùÅ AdminService ΓÇ║ forgotPassword ΓÇ║ 
should handle locked account

    TypeError: AdminRepository.findByEmail.mo
ckResolvedValue is not a function

    [0m [90m 354 |[39m         
resetPasswordLockout[33m:[39m 
[33mDate[39m[33m.[39mnow() [33m+[39m 
[35m10[39m [33m*[39m [35m60[39m 
[33m*[39m [35m1000[39m
     [90m 355 |[39m       }[33m;[39m
    [31m[1m>[22m[39m[90m 356 |[39m     
  [33mAdminRepository[39m[33m.[39mfindByE
mail[33m.[39mmockResolvedValue(lockedAdmin)
[33m;[39m
     [90m     |[39m                        
           [31m[1m^[22m[39m
     [90m 357 |[39m
     [90m 358 |[39m       [90m// Act & 
Assert[39m
     [90m 359 |[39m       [36mawait[39m 
[33mTestUtils[39m[33m.[39mexpectAsyncError
([0m

      at Object.mockResolvedValue 
(tests/unit/admin.service.test.js:356:35)

Test Suites: 1 failed, 1 total
Tests:       17 failed, 17 total
Snapshots:   0 total
Time:        8.844 s, estimated 9 s
Ran all test suites matching 
/tests\\unit\\admin.service.test.js/i.
